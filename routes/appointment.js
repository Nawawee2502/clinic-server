// routes/appointments.js
const express = require('express');
const router = express.Router();

// GET all appointments with filters
router.get('/', async (req, res) => {
    try {
        const db = await require('../config/db');
        const {
            page = 1, limit = 50, status, doctor_code, hncode,
            date_from, date_to, search
        } = req.query;
        const offset = (page - 1) * limit;

        let whereClause = 'WHERE 1=1';
        let params = [];

        if (status) {
            whereClause += ' AND a.STATUS = ?';
            params.push(status);
        }
        if (doctor_code) {
            whereClause += ' AND a.DOCTOR_CODE = ?';
            params.push(doctor_code);
        }
        if (hncode) {
            whereClause += ' AND a.HNCODE = ?';
            params.push(hncode);
        }
        if (date_from) {
            whereClause += ' AND a.APPOINTMENT_DATE >= ?';
            params.push(date_from);
        }
        if (date_to) {
            whereClause += ' AND a.APPOINTMENT_DATE <= ?';
            params.push(date_to);
        }
        if (search) {
            whereClause += ' AND (p.NAME1 LIKE ? OR p.SURNAME LIKE ? OR p.HNCODE LIKE ?)';
            const searchTerm = `%${search}%`;
            params.push(searchTerm, searchTerm, searchTerm);
        }

        const [rows] = await db.execute(`
            SELECT 
                a.APPOINTMENT_ID,
                a.APPOINTMENT_DATE,
                a.APPOINTMENT_TIME,
                a.REASON,
                a.STATUS,
                a.VN_NUMBER, -- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° VN_NUMBER
                a.CREATED_AT,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                p.HNCODE,
                p.PRENAME,
                p.NAME1,
                p.SURNAME,
                p.AGE,
                p.SEX,
                p.TEL1,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠
                doc.EMP_NAME as DOCTOR_NAME,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î
                creator.EMP_NAME as CREATED_BY_NAME
            FROM APPOINTMENT_SCHEDULE a
            JOIN patient1 p ON CONVERT(a.HNCODE USING utf8) = CONVERT(p.HNCODE USING utf8)
            LEFT JOIN EMPLOYEE1 doc ON CONVERT(a.DOCTOR_CODE USING utf8) = CONVERT(doc.EMP_CODE USING utf8)
            LEFT JOIN EMPLOYEE1 creator ON CONVERT(a.CREATED_BY USING utf8) = CONVERT(creator.EMP_CODE USING utf8)
            ${whereClause}
            ORDER BY a.APPOINTMENT_DATE DESC, a.APPOINTMENT_TIME DESC
            LIMIT ? OFFSET ?
        `, [...params, parseInt(limit), parseInt(offset)]);

        // Get total count
        const [countResult] = await db.execute(`
            SELECT COUNT(*) as total 
            FROM APPOINTMENT_SCHEDULE a 
            JOIN patient1 p ON CONVERT(a.HNCODE USING utf8) = CONVERT(p.HNCODE USING utf8)
            ${whereClause}
        `, params);

        res.json({
            success: true,
            data: rows,
            pagination: {
                page: parseInt(page),
                limit: parseInt(limit),
                total: countResult[0].total,
                totalPages: Math.ceil(countResult[0].total / limit)
            }
        });
    } catch (error) {
        console.error('Error fetching appointments:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

// GET appointment by ID
router.get('/:id', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { id } = req.params;
        const [rows] = await db.execute(`
            SELECT 
                a.*,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                p.PRENAME,
                p.NAME1,
                p.SURNAME,
                p.AGE,
                p.SEX,
                p.IDNO,
                p.TEL1,
                p.ADDR1,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠
                doc.EMP_NAME as DOCTOR_NAME,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î
                creator.EMP_NAME as CREATED_BY_NAME
            FROM APPOINTMENT_SCHEDULE a
            JOIN patient1 p ON CONVERT(a.HNCODE USING utf8) = CONVERT(p.HNCODE USING utf8)
            LEFT JOIN EMPLOYEE1 doc ON CONVERT(a.DOCTOR_CODE USING utf8) = CONVERT(doc.EMP_CODE USING utf8)
            LEFT JOIN EMPLOYEE1 creator ON CONVERT(a.CREATED_BY USING utf8) = CONVERT(creator.EMP_CODE USING utf8)
            WHERE a.APPOINTMENT_ID = ?
        `, [id]);

        if (rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'
            });
        }

        res.json({
            success: true,
            data: rows[0]
        });
    } catch (error) {
        console.error('Error fetching appointment:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

// GET appointments by date range
router.get('/date/:date', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { date } = req.params;
        const { doctor_code, status } = req.query;

        let whereClause = 'WHERE a.APPOINTMENT_DATE = ?';
        let params = [date];

        if (doctor_code) {
            whereClause += ' AND a.DOCTOR_CODE = ?';
            params.push(doctor_code);
        }
        if (status) {
            whereClause += ' AND a.STATUS = ?';
            params.push(status);
        }

        const [rows] = await db.execute(`
            SELECT 
                a.APPOINTMENT_ID,
                a.APPOINTMENT_TIME,
                a.REASON,
                a.STATUS,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                p.HNCODE,
                p.PRENAME,
                p.NAME1,
                p.SURNAME,
                p.AGE,
                p.TEL1,
                -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠
                doc.EMP_NAME as DOCTOR_NAME
            FROM APPOINTMENT_SCHEDULE a
            JOIN patient1 p ON CONVERT(a.HNCODE USING utf8) = CONVERT(p.HNCODE USING utf8)
            LEFT JOIN EMPLOYEE1 doc ON CONVERT(a.DOCTOR_CODE USING utf8) = CONVERT(doc.EMP_CODE USING utf8)
            ${whereClause}
            ORDER BY a.APPOINTMENT_TIME
        `, params);

        res.json({
            success: true,
            data: rows,
            count: rows.length,
            date: date
        });
    } catch (error) {
        console.error('Error fetching appointments by date:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
            error: error.message
        });
    }
});

// GET appointments by patient HN
router.get('/patient/:hn', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { hn } = req.params;
        const { page = 1, limit = 20, status } = req.query;
        const offset = (page - 1) * limit;

        let whereClause = 'WHERE a.HNCODE = ?';
        let params = [hn];

        if (status) {
            whereClause += ' AND a.STATUS = ?';
            params.push(status);
        }

        const [rows] = await db.execute(`
            SELECT 
                a.APPOINTMENT_ID,
                a.APPOINTMENT_DATE,
                a.APPOINTMENT_TIME,
                a.REASON,
                a.STATUS,
                a.CREATED_AT,
                doc.EMP_NAME as DOCTOR_NAME
            FROM APPOINTMENT_SCHEDULE a
            LEFT JOIN EMPLOYEE1 doc ON CONVERT(a.DOCTOR_CODE USING utf8) = CONVERT(doc.EMP_CODE USING utf8)
            ${whereClause}
            ORDER BY a.APPOINTMENT_DATE DESC, a.APPOINTMENT_TIME DESC
            LIMIT ? OFFSET ?
        `, [...params, parseInt(limit), parseInt(offset)]);

        const [countResult] = await db.execute(`
            SELECT COUNT(*) as total FROM APPOINTMENT_SCHEDULE a ${whereClause}
        `, params);

        res.json({
            success: true,
            data: rows,
            pagination: {
                page: parseInt(page),
                limit: parseInt(limit),
                total: countResult[0].total,
                totalPages: Math.ceil(countResult[0].total / limit)
            }
        });
    } catch (error) {
        console.error('Error fetching appointments by patient:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
            error: error.message
        });
    }
});

// ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô POST create appointment
router.post('/', async (req, res) => {
    try {
        const db = await require('../config/db');
        const {
            HNCODE, APPOINTMENT_DATE, APPOINTMENT_TIME, REASON,
            DOCTOR_CODE, CREATED_BY
            // ‚úÖ ‡∏•‡∏ö vnNumber ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
        } = req.body;

        console.log('üì• Received appointment data:', req.body);

        if (!HNCODE || !APPOINTMENT_DATE || !APPOINTMENT_TIME) {
            return res.status(400).json({
                success: false,
                message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Hospital Number, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î'
            });
        }

        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á VN Number ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
        const appointmentDate = new Date(APPOINTMENT_DATE);
        const buddhistYear = (appointmentDate.getFullYear() + 543).toString().slice(-2);
        const month = String(appointmentDate.getMonth() + 1).padStart(2, '0');
        const day = String(appointmentDate.getDate()).padStart(2, '0');

        // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î
        const [vnCount] = await db.execute(`
            SELECT COUNT(*) + 1 as next_number
            FROM APPOINTMENT_SCHEDULE 
            WHERE APPOINTMENT_DATE = ? AND VN_NUMBER IS NOT NULL
        `, [APPOINTMENT_DATE]);

        const runningNumber = vnCount[0].next_number.toString().padStart(3, '0');
        const vnNumber = `VN${buddhistYear}${month}${day}${runningNumber}`;

        const safeData = {
            HNCODE: HNCODE || null,
            APPOINTMENT_DATE: APPOINTMENT_DATE || null,
            APPOINTMENT_TIME: APPOINTMENT_TIME || null,
            REASON: REASON || null,
            DOCTOR_CODE: DOCTOR_CODE || null,
            CREATED_BY: CREATED_BY || null,
            VN_NUMBER: vnNumber // ‚úÖ ‡πÉ‡∏ä‡πâ VN Number ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
        const [patientCheck] = await db.execute(
            'SELECT HNCODE, PRENAME, NAME1, SURNAME FROM patient1 WHERE HNCODE = ?',
            [safeData.HNCODE]
        );

        if (patientCheck.length === 0) {
            return res.status(404).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á APPOINTMENT_ID
        const [countResult] = await db.execute(`
            SELECT COUNT(*) + 1 as next_number 
            FROM APPOINTMENT_SCHEDULE 
            WHERE APPOINTMENT_DATE = ?
        `, [safeData.APPOINTMENT_DATE]);

        const appointmentId = `APT${safeData.APPOINTMENT_DATE.replace(/-/g, '')}${countResult[0].next_number.toString().padStart(3, '0')}`;

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏° VN_NUMBER
        const [result] = await db.execute(`
            INSERT INTO APPOINTMENT_SCHEDULE (
                APPOINTMENT_ID, HNCODE, APPOINTMENT_DATE, APPOINTMENT_TIME,
                REASON, DOCTOR_CODE, CREATED_BY, STATUS, VN_NUMBER
            ) VALUES (?, ?, ?, ?, ?, ?, ?, '‡∏ô‡∏±‡∏î‡πÑ‡∏ß‡πâ', ?)
        `, [
            appointmentId,
            safeData.HNCODE,
            safeData.APPOINTMENT_DATE,
            safeData.APPOINTMENT_TIME,
            safeData.REASON,
            safeData.DOCTOR_CODE,
            safeData.CREATED_BY,
            safeData.VN_NUMBER // ‚úÖ VN Number ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
        ]);

        res.status(201).json({
            success: true,
            message: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            data: {
                APPOINTMENT_ID: appointmentId,
                HNCODE: safeData.HNCODE,
                PATIENT_NAME: `${patientCheck[0].PRENAME}${patientCheck[0].NAME1} ${patientCheck[0].SURNAME}`,
                APPOINTMENT_DATE: safeData.APPOINTMENT_DATE,
                APPOINTMENT_TIME: safeData.APPOINTMENT_TIME,
                REASON: safeData.REASON,
                VN_NUMBER: safeData.VN_NUMBER, // ‚úÖ ‡∏™‡πà‡∏á VN Number ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
                STATUS: '‡∏ô‡∏±‡∏î‡πÑ‡∏ß‡πâ'
            }
        });

    } catch (error) {
        console.error('‚ùå Error creating appointment:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

// PUT update appointment
router.put('/:id', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { id } = req.params;
        const {
            APPOINTMENT_DATE, APPOINTMENT_TIME, REASON, DOCTOR_CODE, STATUS
        } = req.body;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
        const [appointmentCheck] = await db.execute(
            'SELECT APPOINTMENT_ID FROM APPOINTMENT_SCHEDULE WHERE APPOINTMENT_ID = ?',
            [id]
        );

        if (appointmentCheck.length === 0) {
            return res.status(404).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'
            });
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≠)
        if (APPOINTMENT_DATE && APPOINTMENT_TIME && DOCTOR_CODE) {
            const [timeCheck] = await db.execute(`
                SELECT APPOINTMENT_ID 
                FROM APPOINTMENT_SCHEDULE 
                WHERE APPOINTMENT_DATE = ? AND APPOINTMENT_TIME = ? AND DOCTOR_CODE = ? 
                  AND STATUS = '‡∏ô‡∏±‡∏î‡πÑ‡∏ß‡πâ' AND APPOINTMENT_ID != ?
            `, [APPOINTMENT_DATE, APPOINTMENT_TIME, DOCTOR_CODE, id]);

            if (timeCheck.length > 0) {
                return res.status(409).json({
                    success: false,
                    message: '‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'
                });
            }
        }

        const [result] = await db.execute(`
            UPDATE APPOINTMENT_SCHEDULE SET 
                APPOINTMENT_DATE = COALESCE(?, APPOINTMENT_DATE),
                APPOINTMENT_TIME = COALESCE(?, APPOINTMENT_TIME),
                REASON = COALESCE(?, REASON),
                DOCTOR_CODE = COALESCE(?, DOCTOR_CODE),
                STATUS = COALESCE(?, STATUS)
            WHERE APPOINTMENT_ID = ?
        `, [APPOINTMENT_DATE, APPOINTMENT_TIME, REASON, DOCTOR_CODE, STATUS, id]);

        res.json({
            success: true,
            message: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            data: {
                APPOINTMENT_ID: id,
                APPOINTMENT_DATE,
                APPOINTMENT_TIME,
                REASON,
                STATUS
            }
        });
    } catch (error) {
        console.error('Error updating appointment:', error);
        if (error.code === 'ER_NO_REFERENCED_ROW_2') {
            res.status(400).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            });
        } else {
            res.status(500).json({
                success: false,
                message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
                error: error.message
            });
        }
    }
});

// PUT update appointment status
router.put('/:id/status', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { id } = req.params;
        const { status, cancelled_reason } = req.body;

        const validStatuses = ['‡∏ô‡∏±‡∏î‡πÑ‡∏ß‡πâ', '‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', '‡πÑ‡∏°‡πà‡∏°‡∏≤', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'];
        if (!validStatuses.includes(status)) {
            return res.status(400).json({
                success: false,
                message: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: ' + validStatuses.join(', ')
            });
        }

        let updateFields = 'STATUS = ?';
        let params = [status];

        if (status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' && cancelled_reason) {
            updateFields += ', CANCELLED_REASON = ?, CANCELLED_AT = NOW()';
            params.push(cancelled_reason);
        }

        params.push(id);

        const [result] = await db.execute(
            `UPDATE APPOINTMENT_SCHEDULE SET ${updateFields} WHERE APPOINTMENT_ID = ?`,
            params
        );

        if (result.affectedRows === 0) {
            return res.status(404).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'
            });
        }

        res.json({
            success: true,
            message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            data: {
                APPOINTMENT_ID: id,
                STATUS: status,
                CANCELLED_REASON: cancelled_reason || null
            }
        });

    } catch (error) {
        console.error('Error updating appointment status:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

// DELETE appointment
router.delete('/:id', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { id } = req.params;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß
        const [queueCheck] = await db.execute(
            'SELECT QUEUE_ID FROM DAILY_QUEUE WHERE APPOINTMENT_ID = ?',
            [id]
        );

        if (queueCheck.length > 0) {
            return res.status(409).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß'
            });
        }

        const [result] = await db.execute(
            'DELETE FROM APPOINTMENT_SCHEDULE WHERE APPOINTMENT_ID = ?',
            [id]
        );

        if (result.affectedRows === 0) {
            return res.status(404).json({
                success: false,
                message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö'
            });
        }

        res.json({
            success: true,
            message: '‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'
        });
    } catch (error) {
        console.error('Error deleting appointment:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

// GET appointment statistics
router.get('/stats/summary', async (req, res) => {
    try {
        const db = await require('../config/db');
        const { date_from, date_to } = req.query;

        let dateFilter = '';
        let params = [];

        if (date_from && date_to) {
            dateFilter = 'WHERE APPOINTMENT_DATE BETWEEN ? AND ?';
            params = [date_from, date_to];
        } else if (date_from) {
            dateFilter = 'WHERE APPOINTMENT_DATE >= ?';
            params = [date_from];
        } else if (date_to) {
            dateFilter = 'WHERE APPOINTMENT_DATE <= ?';
            params = [date_to];
        }

        // Total appointments
        const [totalCount] = await db.execute(
            `SELECT COUNT(*) as total FROM APPOINTMENT_SCHEDULE ${dateFilter}`,
            params
        );

        // Appointments by status
        const [statusStats] = await db.execute(`
            SELECT STATUS, COUNT(*) as count 
            FROM APPOINTMENT_SCHEDULE ${dateFilter}
            GROUP BY STATUS
        `, params);

        // Appointments by doctor
        const [doctorStats] = await db.execute(`
            SELECT 
                e.EMP_NAME,
                COUNT(a.APPOINTMENT_ID) as appointment_count
            FROM APPOINTMENT_SCHEDULE a
            LEFT JOIN EMPLOYEE1 e ON CONVERT(a.DOCTOR_CODE USING utf8) = CONVERT(e.EMP_CODE USING utf8)
            ${dateFilter}
            GROUP BY a.DOCTOR_CODE, e.EMP_NAME
            ORDER BY appointment_count DESC
            LIMIT 10
        `, params);

        // Daily appointment counts
        const [dailyStats] = await db.execute(`
            SELECT 
                APPOINTMENT_DATE,
                COUNT(*) as count
            FROM APPOINTMENT_SCHEDULE ${dateFilter}
            GROUP BY APPOINTMENT_DATE
            ORDER BY APPOINTMENT_DATE DESC
            LIMIT 30
        `, params);

        res.json({
            success: true,
            data: {
                totalAppointments: totalCount[0].total,
                byStatus: statusStats,
                byDoctor: doctorStats,
                dailyCounts: dailyStats,
                dateRange: { date_from, date_to },
                lastUpdated: new Date().toISOString()
            }
        });
    } catch (error) {
        console.error('Error fetching appointment statistics:', error);
        res.status(500).json({
            success: false,
            message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢',
            error: error.message
        });
    }
});

module.exports = router;